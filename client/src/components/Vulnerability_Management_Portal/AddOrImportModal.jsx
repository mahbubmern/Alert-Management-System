import { Upload, Edit, Image as ImageIcon } from "lucide-react";
import { useState } from "react";
import createToast from "../../utils/createToast";
import API from "../../utils/api";

import { CircleCheckBig } from "lucide-react";

const AddOrImportModal = ({
  isOpen,
  onClose,
  onAdd,
  onImport,
  currentService,
  getAllVulnerability,
}) => {
  const [view, setView] = useState("manual");
  const [parsedData, setParsedData] = useState([]);
  const [error, setError] = useState("");
  const [fileName, setFileName] = useState("");

  // for progress bar

  const [uploadProgress, setUploadProgress] = useState(0);
  const [uploadComplete, setUploadComplete] = useState(false);

  // validation for enum value
  const allowedSeverity = ["Low", "Medium", "High", "Critical"];
  const allowedStatus = [
    "Open",
    "In Progress",
    "Resolved",
    "Closed",
    "Risk Accepted",
  ];
  const allowedAssetCategory = [
    "Production",
    "Staging",
    "Development",
    "Testing",

    "UAT",
    "Internal Infra",
  ];
  const allowedScanType = [
    "Network Scan",
    "App Scan",
    "Database Scan",
    "Config Scan",
    "Host Scan",
  ];

  // form Data init

  const [input, setInput] = useState({
    name: "",
    service: "",
    severity: "Critical",
    status: "Open",
    asset: "",
    assetCategory: "",
    osType: "",
    scanType: "",
    cve: "",
    scanner: "",
    description: "",
    remediation: "",
  });

  //   handle Input Change

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setInput((prevInput) => ({
      ...prevInput,
      [name]: value,
    }));
  };

  //   handle Select Change

  const handleSelectChange = (e) => {
    const { name, value } = e.target;
    setInput((prevInput) => ({
      ...prevInput,
      [name]: value,
    }));
  };

  const handleClose = () => {
    setView("manual");
    setParsedData([]);
    setError("");
    setFileName("");
    onClose();
    setInput({
      name: "",
      service: "",
      severity: "Critical",
      status: "Open",
      asset: "",
      assetCategory: "",
      osType: "",
      scanType: "",
      cve: "",
      scanner: "",
      description: "",
      remediation: "",
    });
  };

  if (!isOpen) return null;

  const handleManualSubmit = async (e) => {
    e.preventDefault();

    const {
      name,
      service,
      severity,
      status,
      asset,
      assetCategory,
      osType,
      scanType,
      cve,
      scanner,
      description,
      remediation,
    } = input;

    const formData = {
      name,
      service,
      severity,
      status,
      asset,
      assetCategory,
      osType,
      scanType,
      cve,
      scanner,
      description,
      remediation,
    };

    if (
      !name ||
      !name?.trim() ||
      !service ||
      !service?.trim() ||
      !status ||
      !status?.trim() ||
      !asset ||
      !asset?.trim() ||
      !assetCategory ||
      !assetCategory?.trim() ||
      !osType ||
      !osType?.trim() ||
      !scanType?.trim() ||
      !cve ||
      !cve?.trim() ||
      !scanner ||
      !scanner?.trim() ||
      !description ||
      !description?.trim() ||
      !remediation ||
      !remediation?.trim()
    ) {
      createToast("All fields are required");
      return;
    }

    // ✅ Frontend enum validation
    if (!allowedSeverity.includes(formData.severity))
      return createToast(
        `Invalid severity. Allowed: ${allowedSeverity.join(", ")}`
      );

    if (!allowedStatus.includes(formData.status))
      return createToast(
        `Invalid status. Allowed: ${allowedStatus.join(", ")}`
      );

    if (!allowedAssetCategory.includes(formData.assetCategory))
      return createToast(
        `Invalid asset category. Allowed: ${allowedAssetCategory.join(", ")}`
      );

    if (!allowedScanType.includes(formData.scanType))
      return createToast(
        `Invalid scan type. Allowed: ${allowedScanType.join(", ")}`
      );

    try {
      const res = await API.post(`/api/v1/vulnerability/add`, formData);
      if (res.data.success) {
        createToast("Vulnerability added successfully!", "success");
        getAllVulnerability();
        setInput({
          name: "",
          service: "",
          severity: "Critical",
          status: "Open",
          asset: "",
          assetCategory: "",
          osType: "",
          scanType: "",
          cve: "",
          scanner: "",
          description: "",
          remediation: "",
        });
      } else {
        createToast("Vulnerability added to failed!");
      }
    } catch (error) {
      console.error("Failed to update alert:");
    }

    // const formData = new FormData(e.target);
    // const newVuln = Object.fromEntries(formData.entries());
    // newVuln.id = Date.now();
    // onAdd(newVuln);
    // handleClose();
  };

  const handleFileChange = (event) => {
    console.log(event.target.files[0]);

    const file = event.target.files[0];
    if (!file) return;

    setFileName(file.name);
    const reader = new FileReader();

    setUploadProgress(0);
    setUploadComplete(false);

    reader.onload = (e) => {
      const text = e.target.result;

      // Detect separator automatically (comma or tab)
      const separator = text.includes("\t") ? "\t" : ",";

      const lines = text.split(/\r\n|\n/).filter((line) => line.trim() !== "");
      if (lines.length < 2) {
        createToast("CSV must have a header and at least one data row.");
        setParsedData([]);
        return;
      }

      // Parse headers
      const headers = lines[0].split(separator).map((h) => h.trim());
      const requiredHeaders = [
        "name",
        "service",
        "severity",
        "status",
        "asset",
        "assetCategory",
        "osType",
        "scanType",
        "cve",
        "scanner",
        "description",
        "remediation",
      ];

      // Validate header presence
      const missingHeaders = requiredHeaders.filter(
        (h) => !headers.includes(h)
      );
      if (missingHeaders.length > 0) {
        createToast(`Missing headers: ${missingHeaders.join(", ")}.`);
        setParsedData([]);
        return;
      }

      // Parse data rows
      const data = lines.slice(1).map((line) => {
        const values = line.split(separator);
        return headers.reduce((obj, header, i) => {
          obj[header] = values[i] ? values[i].trim() : "";
          return obj;
        }, {});
      });

      setParsedData(data);
      setError("");
    };

    reader.readAsText(file);

    // ✅ Reset input so same file can be re-selected
    event.target.value = "";
  };

  const handleImportSubmit = async () => {
    try {
      const res = await API.post(
        `/api/v1/vulnerability/bulkAdd`,
        {
          vulnerabilities: parsedData,
        },
        {
          onUploadProgress: (progressEvent) => {
            const percentCompleted = Math.round(
              (progressEvent.loaded * 100) / progressEvent.total
            );
            setUploadProgress(percentCompleted);
          },
        }
      );

      if (res.status === 201) {
        setUploadComplete(true);
        setUploadProgress(0);
        setParsedData([]);
        setFileName("");
      }
      if (res.data.success) {
        createToast(res.data.message, "success");
        getAllVulnerability();
      } else {
        createToast("Vulnerabilities added to failed!");
      }
    } catch (error) {
      console.error("Failed to update alert:");
    }

    // onImport(parsedData);
    // handleClose();
  };

  return (
    <div className="fixed inset-0 !bg-black/70 bg-opacity-70 flex justify-center items-center z-50">
      <div className="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-3xl text-white">
        <div className="flex border-b border-gray-700 mb-6">
          <button
            onClick={() => setView("manual")}
            className={`flex items-center gap-2 px-4 py-3 text-sm font-semibold transition-colors ${
              view === "manual"
                ? "border-b-2 border-indigo-500 text-white"
                : "text-gray-400 hover:text-white"
            }`}
          >
            <Edit className="h-4 w-4" /> Manual Entry
          </button>
          <button
            onClick={() => setView("csv")}
            className={`flex items-center gap-2 px-4 py-3 text-sm font-semibold transition-colors ${
              view === "csv"
                ? "border-b-2 border-indigo-500 text-white"
                : "text-gray-400 hover:text-white"
            }`}
          >
            <Upload className="h-4 w-4" /> Import from CSV
          </button>
        </div>

        {view === "manual" ? (
          <div>
            <h2 className="text-xl font-bold mb-4">Add New Vulnerability</h2>
            <form onSubmit={handleManualSubmit} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  name="name"
                  placeholder="Vulnerability Name"
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.name}
                  onChange={handleInputChange}
                />
                <input
                  name="asset"
                  placeholder="Asset Name / IP"
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.asset}
                  onChange={handleInputChange}
                />
                <input
                  name="service"
                  placeholder="Service Name"
                  defaultValue={
                    currentService !== "Global" ? currentService : ""
                  }
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.service}
                  onChange={handleInputChange}
                />
                <input
                  name="assetCategory"
                  placeholder="Asset Category (e.g. Production)"
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.assetCategory}
                  onChange={handleInputChange}
                />
                <input
                  name="osType"
                  placeholder="OS Type (e.g. RHEL 8)"
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.osType}
                  onChange={handleInputChange}
                />
                <input
                  name="scanType"
                  placeholder="Scan Type (e.g. Host Scan)"
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.scanType}
                  onChange={handleInputChange}
                />
                <select
                  name="severity"
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.severity || ""}
                  onChange={handleSelectChange}
                >
                  <option>Critical</option>
                  <option>High</option>
                  <option>Medium</option>
                  <option>Low</option>
                </select>
                <select
                  name="status"
                  required
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.status || ""}
                  onChange={handleSelectChange}
                >
                  <option>Open</option>
                  <option>In Progress</option>
                  <option>Resolved</option>
                  <option>Risk Accepted</option>
                </select>
                <input
                  name="cve"
                  placeholder="CVE Information"
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.cve}
                  onChange={handleInputChange}
                />
                <input
                  name="scanner"
                  placeholder="Scanner Name"
                  className="bg-gray-700 p-2 rounded w-full"
                  value={input.scanner}
                  onChange={handleInputChange}
                />
              </div>
              <textarea
                name="description"
                placeholder="Description and PoC"
                rows="3"
                className="bg-gray-700 p-2 rounded w-full"
                value={input.description}
                onChange={handleInputChange}
              ></textarea>
              <textarea
                name="remediation"
                placeholder="Remediation"
                rows="3"
                className="bg-gray-700 p-2 rounded w-full"
                value={input.remediation}
                onChange={handleInputChange}
              ></textarea>
              <div className="flex justify-end !space-x-4 pt-4">
                <button
                  type="button"
                  onClick={handleClose}
                  className="bg-gray-600 hover:bg-gray-500 px-4 py-2 !rounded-lg transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 !rounded-lg transition-colors"
                >
                  Add Vulnerability
                </button>
              </div>
            </form>
          </div>
        ) : (
          <div>
            <h2 className="text-xl font-bold mb-4">
              Import Vulnerabilities from CSV
            </h2>
            <div className="bg-gray-900/50 p-4 rounded-md mb-4 !text-sm">
              <p className="font-semibold mb-2">Instructions:</p>
              <p className="text-gray-300">
                Ensure your CSV file has a header row with columns:{" "}
                <code className="!text-indigo-300">
                  name, service, severity, status, asset, assetCategory, osType,
                  scanType
                </code>
                . Optional columns:{" "}
                <code className="!text-indigo-300">
                  cve, scanner, description, remediation
                </code>
                .
              </p>
            </div>
            <div className="mb-4">
              <label className="w-full !flex items-center justify-center px-4 py-6 bg-gray-700 text-gray-300 rounded-lg shadow-lg tracking-wide uppercase border border-dashed border-gray-600 cursor-pointer hover:bg-gray-600 hover:text-white">
                <Upload className="w-8 h-8 mr-3" />
                <span className="text-base leading-normal">
                  {fileName || "Select a file"}
                </span>
                <input
                  type="file"
                  accept=".csv"
                  className="hidden"
                  onChange={handleFileChange}
                />
              </label>
            </div>
            {error && <p className="text-red-400 mb-4">{error}</p>}
            {parsedData.length > 0 && (
              <div className="mb-4 max-h-48 overflow-y-auto border border-gray-700 rounded-lg">
                <table className="w-full text-left text-sm">
                  <thead className="sticky top-0 bg-gray-700">
                    <tr>
                      {Object.keys(parsedData[0]).map((h) => (
                        <th key={h} className="p-2">
                          {h}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {parsedData.slice(0, 10).map((row, i) => (
                      <tr key={i} className="border-t border-gray-600">
                        {Object.values(row).map((val, j) => (
                          <td key={j} className="p-2 truncate max-w-[100px]">
                            {val}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
                {parsedData.length > 10 && (
                  <p className="text-center text-xs p-2 bg-gray-700">
                    ...and {parsedData.length - 10} more rows.
                  </p>
                )}
              </div>
            )}

            {/* Progress Bar */}
            {uploadProgress > 0 && (
              <div className="mt-4 mb-4">
                <div className="flex items-center justify-between mb-1">
                  <span className="text-sm text-gray-300">Progress</span>
                  <span className="text-sm text-gray-300">
                    {uploadProgress}%
                  </span>
                </div>
                <div className="relative w-full h-3 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="absolute left-0 top-0 h-full bg-blue-500 transition-all duration-500"
                    style={{ width: `${uploadProgress}%` }}
                  ></div>
                </div>

                {/* ✅ Tick mark when complete */}
              </div>
            )}
            {uploadComplete && (
              <div className="flex items-center justify-center mt-3 text-green-400 animate-fadeIn">
                <CircleCheckBig className="w-6 h-6 mr-1" />

                <span className="text-sm font-semibold">Upload Complete!</span>
              </div>
            )}

            <div className="flex justify-end !space-x-4">
              <button
                type="button"
                onClick={handleClose}
                className="bg-gray-600 hover:bg-gray-500 px-4 py-2 !rounded-lg transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={handleImportSubmit}
                disabled={parsedData.length === 0}
                className="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 !rounded-lg transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed"
              >
                Import {parsedData.length || ""} Items
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default AddOrImportModal;
