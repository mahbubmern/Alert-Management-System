import { useEffect, useState } from "react";
import { Download, Image as ImageIcon } from "lucide-react";

const ReportsModal = ({ isOpen, onClose, dataToExport, serviceName }) => {
  const [orgName, setOrgName] = useState("Sonali Bank PLC");
  const [logoDataUrl, setLogoDataUrl] = useState("");
  const [reportTitle, setReportTitle] = useState(
    `${serviceName} Vulnerability Report`
  );
  const [paperSize, setPaperSize] = useState("a4");
  const [logoFileName, setLogoFileName] = useState("");

  useEffect(() => {
    setReportTitle(`${serviceName} Vulnerability Report`);
  }, [serviceName]);

  useEffect(() => {
    if (isOpen) {
      if (!document.getElementById("jspdf-script")) {
        const script = document.createElement("script");
        script.id = "jspdf-script";
        script.src =
          "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
        script.async = true;
        document.body.appendChild(script);
      }
      if (!document.getElementById("jspdf-autotable-script")) {
        const script = document.createElement("script");
        script.id = "jspdf-autotable-script";
        script.src =
          "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js";
        script.async = true;
        document.body.appendChild(script);
      }
    }
  }, [isOpen]);

  const handleLogoChange = (event) => {
    const file = event.target.files[0];
    if (file && file.type.startsWith("image/")) {
      setLogoFileName(file.name);
      const reader = new FileReader();
      reader.onloadend = () => {
        setLogoDataUrl(reader.result);
      };
      reader.readAsDataURL(file);
    } else {
      setLogoFileName("");
      setLogoDataUrl("");
    }
  };

  const handleDownloadPdf = () => {
    if (
      typeof window.jspdf === "undefined" ||
      typeof window.jspdf.jsPDF === "undefined"
    ) {
      alert(
        "Reporting library is still loading. Please try again in a moment."
      );
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "p", unit: "mm", format: paperSize });

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // --- Cover Page ---
    if (logoDataUrl) {
      doc.addImage(logoDataUrl, "PNG", pageWidth / 2 - 15, 60, 30, 30);
    }
    doc.setFontSize(28);
    doc.text(orgName, pageWidth / 2, 110, { align: "center" });
    doc.setFontSize(20);
    doc.text(reportTitle, pageWidth / 2, 125, { align: "center" });
    doc.setFontSize(12);
    doc.setTextColor(150);
    doc.text(
      `Report Generated: ${new Date().toLocaleDateString()}`,
      pageWidth / 2,
      140,
      { align: "center" }
    );

    // --- Data Table Page(s) ---
    doc.addPage();

    const tableColumn = [
      "Name",
      "Severity",
      "Status",
      "Asset",
      "Category",
      "OS",
      "CVE",
    ];
    const tableRows = dataToExport.map((item) => [
      item.name,
      item.severity,
      item.status,
      item.asset,
      item.assetCategory,
      item.osType,
      item.cve || "N/A",
    ]);

    doc.autoTable({
      head: [tableColumn],
      body: tableRows,
      startY: 20,
      theme: "grid",
      headStyles: { fillColor: [44, 62, 80] }, // Dark blue-gray header
      styles: { fontSize: 8 },
      columnStyles: { 0: { cellWidth: 50 } }, // Wider column for name
    });

    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 2; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(150);
      doc.text(
        `Page ${i - 1} of ${pageCount - 1}`,
        doc.internal.pageSize.width - 25,
        doc.internal.pageSize.height - 10
      );
    }

    doc.save(
      `Vulnerability_Report_${serviceName.replace(" ", "_")}_${
        new Date().toISOString().split("T")[0]
      }.pdf`
    );
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 !bg-black/70 bg-opacity-70  flex justify-center items-center z-50">
      <div className="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-lg text-white">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold">Customize PDF Report</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-white">
            &times;
          </button>
        </div>
        <div className="space-y-4 mb-6">
          <div>
            <label className="text-sm font-semibold text-gray-400">
              Organization Name
            </label>
            <input
              value={orgName}
              onChange={(e) => setOrgName(e.target.value)}
              className="bg-gray-700 p-2 rounded w-full mt-1"
            />
          </div>
          <div>
            <label className="text-sm font-semibold text-gray-400">
              Organization Logo
            </label>
            <label className="w-full flex items-center justify-center px-4 py-3 bg-gray-700 text-gray-300 rounded-lg shadow-sm tracking-wide border border-dashed border-gray-600 cursor-pointer hover:bg-gray-600 hover:text-white mt-1">
              <ImageIcon className="w-6 h-6 mr-3" />
              <span className="text-sm leading-normal">
                {logoFileName || "Upload an image"}
              </span>
              <input
                type="file"
                accept="image/png, image/jpeg"
                className="hidden"
                onChange={handleLogoChange}
              />
            </label>
          </div>
          <div>
            <label className="text-sm font-semibold text-gray-400">
              Report Title
            </label>
            <input
              value={reportTitle}
              onChange={(e) => setReportTitle(e.target.value)}
              className="bg-gray-700 p-2 rounded w-full mt-1"
            />
          </div>
          <div>
            <label className="text-sm font-semibold text-gray-400 block mb-2">
              Paper Size
            </label>
            <div className="flex bg-gray-700 rounded-lg p-1">
              <button
                onClick={() => setPaperSize("a4")}
                className={`px-4 py-2 text-sm font-semibold rounded-md w-1/2 transition-colors ${
                  paperSize === "a4"
                    ? "bg-indigo-600 text-white"
                    : "text-gray-300"
                }`}
              >
                A4
              </button>
              <button
                onClick={() => setPaperSize("letter")}
                className={`px-4 py-2 text-sm font-semibold rounded-md w-1/2 transition-colors ${
                  paperSize === "letter"
                    ? "bg-indigo-600 text-white"
                    : "text-gray-300"
                }`}
              >
                Letter
              </button>
            </div>
          </div>
        </div>
        <button
          onClick={handleDownloadPdf}
          className="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-4 py-3 !rounded-lg transition-colors"
        >
          <Download className="h-5 w-5 mr-2" /> Download PDF
        </button>
      </div>
    </div>
  );
};

export default ReportsModal;
