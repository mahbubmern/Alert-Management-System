import { useMemo, useState, useEffect, useCallback } from "react";
import Title from "../../../components/Title/Title";
import AddOrImportModal from "../../../components/Vulnerability_Management_Portal/AddOrImportModal.jsx";
import AssetsModal from "../../../components/Vulnerability_Management_Portal/AssetsModal.jsx";
import DashboardCard from "../../../components/Vulnerability_Management_Portal/DashboardCard.jsx";
import ReportsModal from "../../../components/Vulnerability_Management_Portal/ReportsModal.jsx";
import {
  Shield,
  Server,
  Bug,
  Clock,
  Plus,
  ChevronDown,
  ChevronUp,
  Search,
  FileText,
  Layers,
  Info,
  AlertTriangle,
  CheckCircle,
  MoreVertical,
  PlayCircle,
  AlertOctagon,
  ChevronLeft,
  ChevronRight,
} from "lucide-react";
import formatTimeAgo from "../../../components/Vulnerability_Management_Portal/formatTimeAgo.js";
import API from "../../../utils/api.js";
import createToast from "../../../utils/createToast.js";
import ReactPaginate from "react-paginate"; // ✅ Import React Paginate
import { useSelector } from "react-redux";
import { authSelector } from "../../../features/auth/authSlice.js";

// --- CONSTANTS ---
const SEVERITY_COLORS = {
  Critical: "#ef4444",
  High: "#f97316",
  Medium: "#eab308",
  Low: "#22c55e",
};

const STATUS_COLORS = {
  Open: "bg-red-500/20 text-red-400",
  "In Progress": "bg-amber-500/20 text-amber-400",
  Resolved: "bg-green-500/20 text-green-400",
  "Risk Accepted": "bg-sky-500/20 text-sky-400",
};

// --- HELPER HOOKS ---
const useDebounce = (value, delay) => {
  const [debouncedValue, setDebouncedValue] = useState(value);
  useEffect(() => {
    const handler = setTimeout(() => setDebouncedValue(value), delay);
    return () => clearTimeout(handler);
  }, [value, delay]);
  return debouncedValue;
};

// --- SUB-COMPONENTS ---

const ScanDetails = ({ vulnerabilities }) => {
  if (!vulnerabilities || vulnerabilities.length === 0) {
    return (
      <div className="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center justify-center h-full">
        <p className="text-gray-400">No scan data available on this page.</p>
      </div>
    );
  }

  const latestScanDate = new Date(
    Math.max(...vulnerabilities.map((v) => new Date(v.scanTime)))
  );
  const scannersUsed = [...new Set(vulnerabilities.map((v) => v.scanner))];
  const totalTargets = [...new Set(vulnerabilities.map((v) => v.asset))].length;

  return (
    <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h3 className="font-bold text-lg mb-4 text-white flex items-center">
        <Info className="h-5 w-5 mr-2 text-sky-400" />
        Scan Information (Current Page)
      </h3>
      <div className="space-y-4 text-sm">
        <div className="flex justify-between items-center border-b border-gray-700 pb-2">
          <p className="text-gray-400">Last Scan Time</p>
          <p className="text-white font-semibold">
            {latestScanDate.toLocaleString()}
          </p>
        </div>
        <div className="flex justify-between items-center border-b border-gray-700 pb-2">
          <p className="text-gray-400">Scanners Used</p>
          <p className="text-white font-semibold">{scannersUsed.join(", ")}</p>
        </div>
        <div className="flex justify-between items-center">
          <p className="text-gray-400">Targets (Page)</p>
          <p className="text-white font-semibold">{totalTargets}</p>
        </div>
      </div>
    </div>
  );
};

const SeverityBreakdown = ({ vulnerabilities }) => {
  const [expandedSeverity, setExpandedSeverity] = useState(null);

  const severityCounts = useMemo(() => {
    return vulnerabilities.reduce((acc, vuln) => {
      acc[vuln.severity] = (acc[vuln.severity] || 0) + 1;
      return acc;
    }, {});
  }, [vulnerabilities]);

  const handleToggle = (severity) => {
    setExpandedSeverity((prev) => (prev === severity ? null : severity));
  };

  const getTop5ForSeverity = (severity) => {
    return vulnerabilities
      .filter((v) => v.severity === severity)
      .sort((a, b) => new Date(b.scanTime) - new Date(a.scanTime))
      .slice(0, 5);
  };

  return (
    <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h3 className="font-bold text-lg mb-4 text-white flex items-center">
        <AlertTriangle className="h-5 w-5 mr-2 text-red-500" />
        Severity Breakdown (Current Page)
      </h3>
      <div className="space-y-2">
        {["Critical", "High", "Medium", "Low"].map((severity) => {
          const count = severityCounts[severity] || 0;
          const top5 =
            expandedSeverity === severity ? getTop5ForSeverity(severity) : [];

          return (
            <div
              key={severity}
              className="bg-gray-700/50 rounded-lg transition-all duration-300"
            >
              <button
                onClick={() => handleToggle(severity)}
                className="w-full flex items-center justify-between p-3 text-left"
              >
                <div className="flex items-center">
                  <span
                    className="w-3 h-3 rounded-full mr-3"
                    style={{ backgroundColor: SEVERITY_COLORS[severity] }}
                  ></span>
                  <span className="font-semibold text-white">{severity}</span>
                </div>
                <div className="flex items-center">
                  <span className="font-bold text-white mr-3">{count}</span>
                  <ChevronDown
                    className={`h-5 w-5 text-gray-400 transition-transform duration-300 ${
                      expandedSeverity === severity ? "rotate-180" : ""
                    }`}
                  />
                </div>
              </button>
              {expandedSeverity === severity && (
                <div className="p-3 border-t border-gray-600">
                  {top5.length > 0 ? (
                    <div className="space-y-2">
                      {top5.map((vuln) => (
                        <div key={vuln._id || vuln.id} className="text-xs">
                          <p className="font-semibold text-white truncate">
                            {vuln.name}
                          </p>
                          <p className="text-gray-400">
                            on {vuln.asset} - {formatTimeAgo(vuln.scanTime)}
                          </p>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-xs text-gray-400 text-center">
                      No vulnerabilities found for this severity on this page.
                    </p>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
};

const ActionMenu = ({ vuln, onStatusChange, onClose, userRole }) => {
  const handleAction = async (status) => {
    try {
      const res = await API.patch(`/api/v1/vulnerability/status/${vuln._id}`, {
        status,
      });

      if (res.data.success === true) {
        createToast("Status updated!", "success");
        onStatusChange(vuln._id, status);
        onClose();
      } else {
        createToast("Something went wrong", "error");
      }
    } catch (error) {
      createToast(
        error?.response?.data?.message || "Error updating status",
        "error"
      );
    }
  };

  return (
    <div className="absolute right-4 mt-2 w-48 bg-gray-700 border border-gray-600 rounded-md shadow-lg z-20">
      <div className="flex justify-end items-center mb-0.5 mr-3">
        <button
          onClick={onClose}
          className="text-gray-700 hover:text-white text-3xl"
        >
          &times;
        </button>
      </div>
      {vuln.status === "Open" && (
        <>
          <button
            disabled={userRole === "Auditor"}
            onClick={() => handleAction("In Progress")}
            className="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 flex items-center"
          >
            <PlayCircle className="w-4 h-4 mr-2" />
            Start Progress
          </button>
          <button
            disabled={userRole === "Auditor"}
            onClick={() => handleAction("Resolved")}
            className="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 flex items-center"
          >
            <CheckCircle className="w-4 h-4 mr-2" />
            Resolve
          </button>
        </>
      )}
      {vuln.status === "In Progress" && (
        <>
          <button
            disabled={userRole === "Auditor"}
            onClick={() => handleAction("Resolved")}
            className="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 flex items-center"
          >
            <CheckCircle className="w-4 h-4 mr-2" />
            Resolve
          </button>
          <button
            disabled={userRole === "Auditor"}
            onClick={() => handleAction("Open")}
            className="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 flex items-center"
          >
            <AlertOctagon className="w-4 h-4 mr-2" />
            Mark as Open
          </button>
        </>
      )}
      {(vuln.status === "Resolved" || vuln.status === "Risk Accepted") && (
        <button
          disabled={userRole === "Auditor"}
          onClick={() => handleAction("Open")}
          className="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 flex items-center"
        >
          <AlertOctagon className="w-4 h-4 mr-2" />
          Re-Open
        </button>
      )}
    </div>
  );
};

// --- MAIN COMPONENT ---
const Vulnerability_Management_Portal = () => {
  const { user } = useSelector(authSelector);

  // --- States ---
  const [vulnerabilities, setVulnerabilities] = useState([]);
  const [loading, setLoading] = useState(false);
  const [services, setServices] = useState(["Global"]);

  // Pagination State
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalDocs, setTotalDocs] = useState(0);
  const itemsPerPage = 10;

  // Filter & Search State
  const [selectedService, setSelectedService] = useState("Global");
  const [searchTerm, setSearchTerm] = useState("");
  const debouncedSearch = useDebounce(searchTerm, 500);

  // Sorting State
  const [sortConfig, setSortConfig] = useState({
    key: "scanTime",
    direction: "descending",
  });

  // Modal & Menu States
  const [isAddOrImportModalOpen, setIsAddOrImportModalOpen] = useState(false);
  const [isAssetsModalOpen, setIsAssetsModalOpen] = useState(false);
  const [isReportsModalOpen, setIsReportsModalOpen] = useState(false);
  const [actionMenuId, setActionMenuId] = useState(null);

  

  // --- API Fetch ---
  const fetchVulnerabilities = useCallback(async () => {
    try {
      setLoading(true);

      const res = await API.get("/api/v1/vulnerability/getAllVulnerability", {
        params: {
          page: currentPage,
          limit: itemsPerPage,
          search: debouncedSearch,
          service: selectedService,
          sortKey: sortConfig.key,
          sortDirection: sortConfig.direction,
        },
      });

      const { data, meta } = res.data;
      setVulnerabilities(data || []);
      setTotalPages(meta?.totalPages || 1);
      setTotalDocs(meta?.totalDocs || 0);
    } catch (error) {
      console.error("Error fetching vulnerabilities:", error);
      createToast("Failed to load data", "error");
    } finally {
      setLoading(false);
    }
  }, [currentPage, debouncedSearch, selectedService, sortConfig]);

  // Initial Fetch & Update
  useEffect(() => {
    fetchVulnerabilities();
  }, [fetchVulnerabilities]);

  // Reset page when Filters/Search change
  useEffect(() => {
    setCurrentPage(1);
  }, [debouncedSearch, selectedService]);


  // --- Fetch Unique Services for Dropdown ---
  useEffect(() => {
    const fetchServices = async () => {
      try {
        const res = await API.get("/api/v1/vulnerability/services");
        if (res.data?.success) {
          // Prepend "Global" to the list from DB
          setServices(["Global", ...res.data.data]);
        }
      } catch (error) {
        console.error("Failed to fetch services list", error);
      }
    };

    fetchServices();
  }, []);

  

  // --- Handlers ---
  const handleSort = (key) => {
    setSortConfig((prev) => ({
      key,
      direction:
        prev.key === key && prev.direction === "ascending"
          ? "descending"
          : "ascending",
    }));
  };

  const handleStatusChange = (id, newStatus) => {
    setVulnerabilities((prev) =>
      prev.map((vuln) =>
        vuln._id === id ? { ...vuln, status: newStatus } : vuln
      )
    );
  };

  // ✅ ReactPaginate Handler (Converts 0-based index to 1-based)
  const handlePageClick = (event) => {
    setCurrentPage(event.selected + 1);
  };


  const getSortIcon = (key) => {
    if (sortConfig.key !== key)
      return <ChevronDown className="h-4 w-4 text-gray-500" />;
    return sortConfig.direction === "ascending" ? (
      <ChevronUp className="h-4 w-4 text-white" />
    ) : (
      <ChevronDown className="h-4 w-4 text-white" />
    );
  };



  

  const dashboardData = useMemo(
    () => ({
      total: totalDocs,
      nonMitigated: vulnerabilities.filter(
        (v) => v.status === "Open" || v.status === "In Progress"
      ).length,
      critical: vulnerabilities.filter(
        (v) =>
          v.severity === "Critical" &&
          (v.status === "Open" || v.status === "In Progress")
      ).length,
      assets: [...new Set(vulnerabilities.map((v) => v.asset))].length,
    }),
    [vulnerabilities, totalDocs]
  );

  const tableHeaders = [
    "Vulnerability Name",
    "Severity",
    "Mitigation Status",
    "Asset Name / IP",
    "Asset Category",
    "OS Type",
    "CVE Information",
    "Scan Type",
    "Scan Time",
    "Actions",
  ];

  return (
    <>
      <Title title={"SEM | Vulnerability_Management_Portal"} />

      <div className="bg-gray-900 text-gray-200 min-h-screen font-sans py-12">
        <nav className="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 px-8 py-3 flex justify-between items-center sticky top-[60px] z-40">
          <div className="flex items-center space-x-3">
            <Shield className="text-indigo-400 h-8 w-8" />
            <h3 className="text-xl font-bold text-white p-0 m-0">
              Vulnerability Management Portal
            </h3>
          </div>
          <div className="flex items-center space-x-4">
            <button
              onClick={() => setIsReportsModalOpen(true)}
              className="text-sm px-2 text-gray-400 hover:text-white transition-colors"
            >
              Reports
            </button>
            <button
              onClick={() => setIsAssetsModalOpen(true)}
              className="text-sm px-3 text-gray-400 hover:text-white transition-colors"
            >
              Assets
            </button>
            <button
              disabled={user?.role === "Auditor"}
              onClick={() => setIsAddOrImportModalOpen(true)}
              className="flex items-center bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-4 py-2  !rounded-lg transition-colors"
            >
              <Plus className="h-5 w-5 mr-2" /> Add Vulnerability
            </button>
          </div>
        </nav>

        <main className="p-8">
          <section id="dashboard" className="mb-6">
            <div className="flex justify-between items-center mb-6">
              <div className="flex items-center gap-4">
                <h2 className="text-xl font-bold text-white">Dashboard</h2>
                <div className="h-8 w-px bg-gray-700"></div>
                <p className="text-gray-400 text-lg font-medium">
                  {selectedService} View
                </p>
              </div>
            </div>

            <div className="bg-gray-800 rounded-lg p-3 mb-6 flex items-center gap-2">
              <Layers className="h-5 w-5 text-gray-400 ml-1 mr-2 flex-shrink-0" />
              <select
                value={selectedService}
                onChange={(e) => setSelectedService(e.target.value)}
                className="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 w-full md:w-auto text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none appearance-none"
                style={{
                  backgroundImage: `url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>')`,
                  backgroundRepeat: "no-repeat",
                  backgroundPosition: "right 0.75rem center",
                  backgroundSize: "1.5em 1.5em",
                }}
              >
                {services.map((service) => (
                  <option key={service} value={service} className="bg-gray-800">
                    {service}
                  </option>
                ))}
              </select>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <DashboardCard
                title="Total Vulnerabilities"
                value={dashboardData.total}
                icon={<Bug className="text-yellow-400 h-6 w-6" />}
              />
              <DashboardCard
                title="Non-Mitigated (Page)"
                value={dashboardData.nonMitigated}
                icon={<Server className="text-orange-400 h-6 w-6" />}
                subtext={`${dashboardData.critical} are critical`}
              />
              <DashboardCard
                title="Assets Affected (Page)"
                value={dashboardData.assets}
                icon={<FileText className="text-green-400 h-6 w-6" />}
              />
              <DashboardCard
                title="Resolved (Page)"
                value={
                  vulnerabilities.filter((v) => v.status === "Resolved").length
                }
                icon={<Clock className="text-sky-400 h-6 w-6" />}
              />
            </div>
          </section>

          <section
            id="visualizations"
            className="mb-12 grid grid-cols-1 lg:grid-cols-2 gap-6"
          >
            <SeverityBreakdown vulnerabilities={vulnerabilities} />
            <ScanDetails vulnerabilities={vulnerabilities} />
          </section>

          <section id="vulnerabilities">
            <div className="bg-gray-800 rounded-lg shadow-lg p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-white">
                  Vulnerability List ({selectedService})
                </h2>
                <div className="relative">
                  <Search className="absolute left-3  top-1/2 -translate-y-1/2 text-gray-400 h-5 w-5" />
                  <input
                    type="text"
                    placeholder="Search by name, asset, or CVE..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 w-80 focus:ring-2 focus:ring-indigo-500 focus:outline-none text-sm"
                  />
                </div>
              </div>

              <div className="relative">
                {/* Loader Overlay */}
                {loading && (
                  <div className="absolute inset-0 z-10 bg-gray-800/70 flex items-center justify-center rounded-lg backdrop-blur-sm">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                  </div>
                )}

                {/* Table Content */}
                <div
                  className={`overflow-x-auto min-h-[400px] transition-opacity duration-200 ${
                    loading ? "opacity-50" : "opacity-100"
                  }`}
                >
                  <div className="w-ful">
                    <table className="w-full text-left">
                      <thead className="border-b border-gray-700">
                        <tr>
                          <th className="p-2 text-sm font-semibold text-gray-400">
                            SI
                          </th>
                          {tableHeaders.map((header) => {
                            const key = {
                              "Vulnerability Name": "name",
                              Severity: "severity",
                              "Mitigation Status": "status",
                              "Asset Name / IP": "asset",
                              "Asset Category": "assetCategory",
                              "OS Type": "osType",
                              "CVE Information": "cve",
                              "Scan Type": "scanType",
                              "Scan Time": "scanTime",
                              Actions: null,
                            }[header];
                            return (
                              <th
                                key={header}
                                className="p-2 text-sm font-semibold text-gray-400"
                                onClick={() => key && handleSort(key)}
                              >
                                <div
                                  className={`flex items-center space-x-1 ${
                                    key && "cursor-pointer"
                                  }`}
                                >
                                  <span>{header}</span>
                                  {key && getSortIcon(key)}
                                </div>
                              </th>
                            );
                          })}
                        </tr>
                      </thead>
                      <tbody>
                        {vulnerabilities.length > 0 ? (
                          vulnerabilities.map((vuln, index) => (
                            <tr
                              key={vuln._id || index}
                              className="border-b border-gray-700 hover:bg-gray-700/50 transition-colors"
                            >
                              <td className="p-2 text-gray-300">
                                {/* Global Index */}
                                {(currentPage - 1) * itemsPerPage + index + 1}
                              </td>
                              <td className="p-2 font-medium text-sm text-white">
                                {vuln.name}
                              </td>
                              <td className="p-2">
                                <span
                                  className="font-bold text-sm"
                                  style={{
                                    color: SEVERITY_COLORS[vuln.severity],
                                  }}
                                >
                                  {vuln.severity}
                                </span>
                              </td>
                              <td className="p-2">
                                <span
                                  className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                    STATUS_COLORS[vuln.status]
                                  }`}
                                >
                                  {vuln.status}
                                </span>
                              </td>
                              <td className="p-2 text-gray-300 text-sm">
                                {vuln.asset}
                              </td>
                              <td className="p-2 text-gray-300 text-sm">
                                {vuln.assetCategory}
                              </td>
                              <td className="p-2 text-gray-300 text-sm">
                                {vuln.osType}
                              </td>
                              <td className="p-2 text-gray-300 text-sm">
                                {vuln.cve}
                              </td>
                              <td className="p-2 text-gray-300 text-sm">
                                {vuln.scanType}
                              </td>
                              <td className="p-2 text-gray-300 text-xs">
                                {new Date(vuln.scanTime).toLocaleString()}
                              </td>
                              <td className="p-2 relative">
                                <button
                                  onClick={() =>
                                    setActionMenuId(
                                      actionMenuId === vuln._id
                                        ? null
                                        : vuln._id
                                    )
                                  }
                                  className="p-1 rounded-full hover:bg-gray-600"
                                >
                                  <MoreVertical className="h-5 w-5" />
                                </button>
                                {actionMenuId === vuln._id && (
                                  <ActionMenu
                                    vuln={vuln}
                                    onStatusChange={handleStatusChange}
                                    onClose={() => setActionMenuId(null)}
                                    userRole={user?.role}
                                  />
                                )}
                              </td>
                            </tr>
                          ))
                        ) : (
                          <tr>
                            <td
                              colSpan={11}
                              className="text-center py-10 text-gray-400"
                            >
                              No vulnerabilities found.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>

                    {/* ✅ React Paginate Integration */}
                    <div className="flex justify-between items-center mt-6">
                      <p className="text-gray-400 text-sm">
                        Showing {(currentPage - 1) * itemsPerPage + 1}–
                        {Math.min(currentPage * itemsPerPage, totalDocs)} of{" "}
                        {totalDocs}
                      </p>

                      <ReactPaginate
                        previousLabel="Prev"
                        nextLabel="Next"
                        breakLabel="..."
                        pageCount={totalPages}
                        pageRangeDisplayed={3}
                        marginPagesDisplayed={1}
                        onPageChange={handlePageClick}
                        forcePage={currentPage - 1} // Sync state with internal 0-based index
                        containerClassName="flex flex-wrap justify-center md:justify-end gap-2"
                        // Updated for Dark Mode
                        pageLinkClassName="px-3 py-1 text-sm border border-gray-600 rounded hover:bg-gray-700 text-gray-300 cursor-pointer block"
                        previousLinkClassName="px-3 py-1 text-sm border border-gray-600 rounded hover:bg-gray-700 text-gray-300 cursor-pointer block"
                        nextLinkClassName="px-3 py-1 text-sm border border-gray-600 rounded hover:bg-gray-700 text-gray-300 cursor-pointer block"
                        breakLinkClassName="px-2 py-1 text-xs border border-gray-600 rounded cursor-default block text-gray-500"
                        activeLinkClassName="!bg-indigo-600 !border-indigo-600 !text-white"
                        disabledLinkClassName="opacity-50 cursor-not-allowed hover:bg-transparent"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </main>

        <AddOrImportModal
          isOpen={isAddOrImportModalOpen}
          onClose={() => setIsAddOrImportModalOpen(false)}
          onAdd={() => fetchVulnerabilities()}
          onImport={() => {
            fetchVulnerabilities();
            setSelectedService("Global");
          }}
          currentService={selectedService}
        />
        <AssetsModal
          isOpen={isAssetsModalOpen}
          onClose={() => setIsAssetsModalOpen(false)}
          vulnerabilities={vulnerabilities}
          serviceName={selectedService}
        />
        <ReportsModal
          isOpen={isReportsModalOpen}
          onClose={() => setIsReportsModalOpen(false)}
          dataToExport={vulnerabilities}
          serviceName={selectedService}
        />
      </div>
    </>
  );
};

export default Vulnerability_Management_Portal;